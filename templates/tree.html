{% extends "base.html" %}
{% block content %}

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Graph</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>


        .node circle {
            fill: #fff;
            stroke: steelblue;
            stroke-width: 3px;
        }

        .node text {
            font: 12px sans-serif;
        }

        .link {
            fill: none;
            stroke: black; /* Make the lines black */
            stroke-width: 2px;
        }


        #container {
            display: flex;
            height: 80vh;
            border-bottom: 1px solid lightgray;
        }
        #network {
            flex-grow: 1;
            border-right: 1px solid lightgray;
        }
        #details {
            width: 10%;
            padding: 5px;
            overflow-y: auto;
        }
        #functions {
            display: flex;
            justify-content: space-evenly;
            background-color: #f7f7f7;
            border-top: 1px solid lightgray;
        }
        .tab {
            padding: 10px;
            text-align: center;
            cursor: pointer;
            border-right: 1px solid lightgray;
            flex-grow: 1;
        }
        .tab:last-child {
            border-right: none;
        }
        .active-tab {
            background-color: #e0e0e0;
        }
        #function-content {
            padding: 10px;
            height: 30vh; /* Increased height */
        }

        .node-label {
            pointer-events: none;
            text-anchor: middle;
            font-size: 12px;
        }

        .link-label {
            pointer-events: none;
            text-anchor: middle;
            font-size: 10px;
        }

    </style>
</head>
<body>
    <div id="container">
        <div id="network"></div>
        <div id="details">Hover over a node to see details here.</div>
    </div>
    <div id="functions">
        <div class="tab active-tab" onclick="changeTabContent('Update User')">Update User</div>
        <div class="tab" onclick="changeTabContent('Add User')">Add User</div>
        <div class="tab" onclick="changeTabContent('Delete Relationship')">Delete Relationship</div>
        <div class="tab" onclick="changeTabContent('Add Relationship')">Add Relationship</div>
        <div class="tab" onclick="changeTabContent('Find Path')">Find Path</div>
    </div>
    <div id="function-content">
        <p>Click on a user to update their information.</p>
        <button onclick="submitUpdateUser()">Update User</button>
        <div id="pathResults"></div>
    </div>


<script>

let selectedNodes = [];

let selectedLink = null;

let currTab = 'Update User';

let data = null;



// Function to select a link when clicked
function selectLink(event, d) {
    selectedLink = d;
    // Display details about the selected link in some UI element, e.g., a sidebar or modal
    if(currTab === 'Delete Relationship'){
        console.log('Deleting relationship:', d);
        document.getElementById('pathResults').innerHTML = `Selected relationship: <b>${d.type}</b> between <b>${d.source.name}</b> and <b>${d.target.name}</b>`;
        selectedLink = d;
    }
}


// some mock data for testing
// let data =  {
//                 nodes: [
//                     {id: 1, name: 'Jimmy Bob', dateOfBirth: 'Mon, 27 Feb 1967 00:00:00 GMT', hobbies: ['tennis', 'golf']},
//                     {id: 2, name: 'Alice Bob', dateOfBirth: 'Tue, 27 Feb 1968 00:00:00 GMT', hobbies: ['reading', 'painting']},
//                     {id: 3, name: 'Bob Bob', dateOfBirth: 'Wed, 27 Feb 1969 00:00:00 GMT', hobbies: ['swimming', 'hiking']},
//                     {id: 4, name: 'Charlie Bob', dateOfBirth: 'Thu, 27 Feb 1970 00:00:00 GMT', hobbies: ['cooking', 'gardening']}
//                 ],

//                 connections: [
//                     {rel_id: 0, source: 1, target: 2, type: 'marriage'},
//                     {rel_id: 1, source: 1, target: 3, type: 'parent-child'},
//                     {rel_id: 2, source: 2, target: 3, type: 'parent-child'},
//                     {rel_id: 3, source: 1, target: 4, type: 'parent-child'}

//                 ]
//             };

        // Function to make API call and display family tree
        async function getFamilyTree() {
        
            // fetch data
            // make an API call to get the family tree data
            try {
        // Make an API call to get the family tree data and wait for it to complete
        const response = await fetch('/generatetree/');
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        data = await response.json();  // Parse JSON data from the response

        console.log(data);  // Now `data` is available and logged correctly
        renderFamilyTree(data);  // Now `data` is passed correctly
    } catch (error) {
        console.error('Failed to fetch the family tree data:', error);
    }
        }

        // Function to render family tree using D3.js
        function renderFamilyTree(data) {
            const width = document.getElementById('network').clientWidth;
            const height = document.getElementById('network').clientHeight;
            // const svg = d3.select("#network").append("svg")
            //               .attr("width", width)
            //               .attr("height", height);



            const svg = d3.select("#network").append("svg")
    .attr("width", width)
    .attr("height", height)
    .call(d3.zoom().on("zoom", (event) => {
        svg.attr("transform", event.transform);
    }))
    .append("g");

    
            const nodes = data.nodes;
            const links = data.connections;

            // const simulation = d3.forceSimulation(nodes)
            //          .force("link", d3.forceLink(links).id(d => d.id).distance(300)) // Increase link distance
            //          .force("charge", d3.forceManyBody().strength(-200)) // Increase repulsive force
            //          .force("center", d3.forceCenter(width / 2, height / 2));


                     const simulation = d3.forceSimulation(nodes)
        .force("link", d3.forceLink(links).id(d => d.id).distance(200)) // Increased link distance
        .force("charge", d3.forceManyBody().strength(-500)) // Increased repulsive force
        .force("center", d3.forceCenter(width / 2, height / 2))
        .force("collide", d3.forceCollide().radius(100)); // Added collision force to avoid overlap


    //         const simulation = d3.forceSimulation(nodes)
    // .force("charge", d3.forceManyBody().strength(-300))  // Adjust this value as needed
    // .force("center", d3.forceCenter(width / 2, height / 2))
    // .force("collide", d3.forceCollide().radius(function(d) { return d.radius + 10; }));




const link = svg.selectAll(".link")
            .data(links)
            .enter().append("line")
            .attr("class", "link")
            .style("stroke", d => {
                if (d.type === 'marriage') {
                    return "red";
                } else if (d.type === 'parent-child') {
                    return "green";
                } else {
                    return "gray";
                }
            })
            .style("stroke-width", 4)
            .on('mouseover', linkMouseover) // Updated to use the function
            .on('mouseout', linkMouseout)
            .on('click', selectLink);



    const linkLabels = svg.selectAll(".link-label")
            .data(links)
            .enter().append("text")
            .attr("class", "link-label")
            .text(d => d.type)
            .on('mouseover', linkMouseover) // Attach the same mouseover event
            .on('mouseout', linkMouseout)
            .on('click', selectLink);  // Add click event handler to labels as well;

    // Function to handle mouseover event on links and labels
    function linkMouseover(event, d) {
        const sourceNode = nodes.find(node => node.id === d.source.id);
        const targetNode = nodes.find(node => node.id === d.target.id);
        let detailsText = '';
        if (d.type === 'marriage') {
            detailsText = `${sourceNode.name} is married to ${targetNode.name}`;
        } else if (d.type === 'parent-child') {
            detailsText = `${sourceNode.name} is the parent of ${targetNode.name}`;
        }
        document.getElementById('details').innerHTML = detailsText;
    }

    function linkMouseout(event, d) {
        document.getElementById('details').innerHTML = 'Hover over a relationship to see details here.';
    }

            // Draw circles for the nodes
            const node = svg.selectAll(".node")
                            .data(nodes)
                            .enter().append("circle")
                            .attr("class", "node")
                            .attr("fill", "white")
                            .attr("border", "black")
                            .attr("stroke", "black") // Add a stroke color if needed
                            .attr("r", 35)
                            .on('mouseover', (event, d) => {
                                const details = document.getElementById('details');
                                details.innerHTML = `Name: ${d.name}<br>Date of Birth: ${d.dateOfBirth}<br>Hobbies: ${d.hobbies.join(', ')}`;
                            })
                            .on('mouseout', (event, d) => {
                                const details = document.getElementById('details');
                                details.innerHTML = 'Hover over a node to see details here.';
                            })
                            .call(drag(simulation));


            node.on('click', (event, d) => {selectNode(d.id);});


            // Add node labels (family member names)
            const nodeLabels = svg.selectAll(".node-label")
                                  .data(nodes)
                                  .enter().append("text")
                                  .attr("class", "node-label")
                                  .attr("dx", "0.25em")
                                  .attr("dy", ".25em")
                                  .text(d => d.name);


            simulation.on("tick", () => {
                link.attr("x1", d => d.source.x)
                    .attr("y1", d => d.source.y)
                    .attr("x2", d => d.target.x)
                    .attr("y2", d => d.target.y);

                node.attr("cx", d => d.x)
                    .attr("cy", d => d.y);


                nodeLabels
                    .attr("x", d => d.x)
                    .attr("y", d => d.y);

                linkLabels
                    .attr("x", d => (d.source.x + d.target.x) / 2)
                    .attr("y", d => (d.source.y + d.target.y) / 2);
            });

            function drag(simulation) {
                function dragstarted(event) {
                    if (!event.active) simulation.alphaTarget(0.3).restart();
                    event.subject.fx = event.subject.x;
                    event.subject.fy = event.subject.y;
                }

                function dragged(event) {
                    event.subject.fx = event.x;
                    event.subject.fy = event.y;
                }

                function dragended(event) {
                    if (!event.active) simulation.alphaTarget(0);
                    event.subject.fx = null;
                    event.subject.fy = null;
                }

                return d3.drag()
                         .on("start", dragstarted)
                         .on("drag", dragged)
                         .on("end", dragended);
            }
        }


        function changeTabContent(tabName) {
            currTab = tabName;

            selectedNodes = [];
            selectedLink = null;
            
            const functionContent = document.getElementById('function-content');
            if (tabName === 'Find Path') {
                functionContent.innerHTML = `
                    <p>Click on two family members to find the path between them.</p>

                    <button onclick="submitPathFind()">Find Path</button>
                    <div id="pathResults"></div>
                `;
            } 

            else if (tabName === 'Add Relationship') {
                functionContent.innerHTML = `
                    <p>Click on two family members to add a relationship between them.</p>

                    <button onclick="submitMarriageRelationshipToAdd()">Add Marriage Relationship</button>
                    <button onclick="submitParentChildRelationshipToAdd()">Add Parent-Child Relationship</button>

                    <div id="pathResults"></div>`;
            } 

            else if (tabName === 'Delete Relationship'){
                functionContent.innerHTML = `
                    <p>Click on a relationship to delete it.</p>
                    <button onclick="deleteRelationship()">Delete Relationship</button>
                    <div id="pathResults"></div>`;
            }

            else if (tabName === 'Add User'){
    functionContent.innerHTML = `
    <a href="{{'add_family_member'}}" class="button">Go to Add User Form</a>`;
}


            else if (tabName === 'Update User'){
                functionContent.innerHTML = `
                    <p>Click on a user to update their information.</p>
                    <button onclick="submitUpdateUser()">Update User</button>
                    <div id="pathResults"></div>`;
                }

            
            
            
            else {
                functionContent.textContent = `${tabName} Content`;
            }

            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                if (tab.textContent === tabName) {
                    tab.classList.add('active-tab');
                } else {
                    tab.classList.remove('active-tab');
                }
            });
        }




        function selectNode(nodeId) {
            console.log('Selected node:', nodeId);
            


            if (currTab == 'Add Relationship' || currTab == 'Find Path'){
                // check if the selected nodes are already selected
                // if so, remove the selection
                // if not, add the selection
                // if two nodes are already selected, remove the selection and add the new selection
                // if two nodes are already selected and one of them is the new selection, remove the selection and add the new selection
            
            if (selectedNodes.length == 2){
                selectedNodes = [];
            }

            if (selectedNodes.length < 2 && !selectedNodes.includes(nodeId)) {
                selectedNodes.push(nodeId);
            } 
            
            else if (selectedNodes.length === 2 && selectedNodes.includes(nodeId)){
                selectedNodes = [nodeId];
            }

            // let familyMemberNames = data.nodes.filter(node => selectedNodes.includes(node.id)).map(node => node.name);
            // make sure names are added in proper order
            let familyMemberNames = [];
            for (let i = 0; i < selectedNodes.length; i++){
                let node = data.nodes.find(node => node.id === selectedNodes[i]);
                familyMemberNames.push(node.name);
            }


            document.getElementById('pathResults').innerHTML = `Selected members are ${familyMemberNames.join(' and ')}`;

            console.log('Selected nodes:', selectedNodes);
        }


        else if (currTab == 'Update User'){
            // make an API call to get the user details
            // populate the form with the user details
            // submit the form to update the user details
            console.log('Updating user:', nodeId);

            selectedNodes = [];

            // add selected node to the array
            selectedNodes.push(nodeId);


            let familyMemberNames = [];
            for (let i = 0; i < selectedNodes.length; i++){
                let node = data.nodes.find(node => node.id === selectedNodes[i]);
                familyMemberNames.push(node.name);
            }

            document.getElementById('pathResults').innerHTML = `Selected member is ${familyMemberNames.join(' and ')}`;

            console.log('Selected nodes:', selectedNodes);
        }

        }







        //////////////// Method to interact with server API ////////////////

        function deleteRelationship() {
    if (!selectedLink) {
        document.getElementById('pathResults').innerHTML = 'No relationship selected.';
        return;
    }

    console.log('Deleting relationship:', selectedLink);

    fetch('/deleterelationship', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({rel_id: selectedLink.rel_id})
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('pathResults').innerHTML = data.message;
        if (response.ok) {
            console.log('Relationship deleted successfully');
        } else {
            console.error('Error:', data.message);
        }
    })
    .catch((error) => {
        console.error('Error:', error);
        document.getElementById('pathResults').innerHTML = 'Error deleting relationship.';
    });

    selectedLink = null; // Reset selected link after deletion
    location.reload(); // Reload the page to update the visualization
}



        function submitPathFind() {
            if (selectedNodes.length === 2) {
                // Implement API call or logic to find the path
                const pathText = `Path found between members: ${selectedNodes.join(' and ')}`;
                document.getElementById('pathResults').innerHTML = pathText;
                selectedNodes = []; // Reset for next search
            } else {
                document.getElementById('pathResults').innerHTML = 'Please select two nodes.';
            }
        }



    function submitMarriageRelationshipToAdd() {
        if (selectedNodes.length !== 2) {
            document.getElementById('pathResults').innerHTML = 'Please select two nodes.';
            return;
        }

        let node1 = selectedNodes[0];
        let node2 = selectedNodes[1];

        console.log('Adding marriage relationship between:', node1, node2);

        fetch('/createmarriage', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({spouse1_id: node1, spouse2_id: node2})
        })
        .then(response => response.json())
        .then(data => {
            document.getElementById('pathResults').innerHTML = data.message;
            if (response.ok) {
                console.log('Marriage Creation successful');
            } else {
                console.error('Error:', data.message);
            }
        })
        .catch((error) => {
            console.error('Error:', error);
        });

        selectedNodes = []; // Reset the selected nodes
//         setTimeout(function() {
//   // Code to execute after the pause
//   console.log("1 second has passed.");
// }, 1000);  // The time delay is in milliseconds, so 1000 ms is 1 second.

        location.reload(); // Reload the page
    }



    function submitParentChildRelationshipToAdd() {
        if (selectedNodes.length !== 2) {
            document.getElementById('pathResults').innerHTML = 'Please select two nodes.';
            return;
        }

        let node1 = selectedNodes[0];
        let node2 = selectedNodes[1];

        console.log('Adding parent-child relationship between:', node1, node2);

        fetch('/createparentchild', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({parent_id: node1, child_id: node2})
        })
        .then(response => response.json())
        .then(data => {
            document.getElementById('pathResults').innerHTML = data.message;
            if (response.ok) {
                console.log('Parent-Child Creation successful');
            } else {
                console.error('Error:', data.message);
            }
        })
        .catch((error) => {
            console.error('Error:', error);
        });

        selectedNodes = []; // Reset the selected nodes
//         setTimeout(function() {
//   // Code to execute after the pause
//   console.log("1 second has passed.");
// }, 1000);  // The time delay is in milliseconds, so 1000 ms is 1 second.

        location.reload(); // Reload the page

    }



        // function submitMarriageRelationshipToAdd(){
        //     // read the selected nodes
        //     // make an API call to add the relationship
        //     if (selectedNodes.length !== 2) {
        //         document.getElementById('pathResults').innerHTML = 'Please select two nodes.';
        //         return;
        //     }

        //     let node1 = selectedNodes[0];
        //     let node2 = selectedNodes[1];

        //     console.log('Adding marriage relationship between:', node1, node2);
        //     selectedNodes = [];

        //     // reset the selected nodes

        //     // update text
        //     location.reload(); // relaod the page
        // }


        // function submitParentChildRelationshipToAdd(){
        //     if (selectedNodes.length !== 2) {
        //         document.getElementById('pathResults').innerHTML = 'Please select two nodes.';
        //         return;
        //     }
        //     // read the selected nodes
        //     // make an API call to add the relationship
        //     let node1 = selectedNodes[0];
        //     let node2 = selectedNodes[1];

        //     console.log('Adding parent-child relationship between:', node1, node2);
        //     selectedNodes = [];

        //     location.reload();
        // }

    

        function submitUpdateUser(){
            // redirect to form with user queries
            if(selectedNodes.length === 1){
                console.log('Updating user:', selectedNodes[0]);
                selectedNodes = [];

                location.reload();
            }

            else {
                document.getElementById('pathResults').innerHTML = 'Please select a node.';
            }
        }

        // Call getFamilyTree function when the page loads
        getFamilyTree();
    </script>
</body>
</html>


{% endblock %}
